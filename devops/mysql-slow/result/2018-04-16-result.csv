QUERY ID,执行次数,min,max,avg,95%,用户,查询语句,业务场景,修复计划
71,10,2s,8s,3s,3s,misuser,"SELECT CASE WHEN (SELECT COUNT(*) FROM mis_work_order orders WHERE orders.orderFid=o.contractId AND orders.configType='WARN' AND orders.status=1)>0 THEN 1 ELSE 0 END isOrderWarn, ec.consultantId, ec.cooperateConsultantId, ec.createdByFid, o.`contractId`, o.`clientId`, c.contractType, o.`orderProp`, o.`teachProp`, o.`orderStatus`, o.`realLessonCount`, o.`teacherId`, o.`teacherName`, o.`subjectId`, o.`gradeId`, o.`createTime`, c.`contractNo`, u.`userRealName` as chargeName, ec.`clientName` realName, ec.`clientName` parentRealName, ec.`chargeFid`, ec.`phoneNo` AS parentTel, ec.`phoneNo` AS studentTel, s.`statusDesc`, u.`userOrgFid`, u.`userId`, tu2.`userOrgFid` as ccUserOrgFid, tu2.`userId` as ccUserId, CASE WHEN o.`orderProp` = 1 THEN '新' WHEN o.`orderProp` = 2 THEN '续' WHEN o.`orderProp` = 3 THEN '扩' WHEN o.`orderProp` = 4 THEN '赠' ELSE '' END AS orderPropDesc, CASE WHEN o.`teachProp` = 1 THEN '新签' WHEN o.`teachProp` = 2 THEN '续科' WHEN o.`teachProp` = 3 THEN '赠送' ELSE '' END AS teachPropDesc, maxel.startTime AS lessonStartTime, (o.`realLessonCount` - ifNUll(maxel.courseHours,0)) AS remainHours, IF(elr.orderFid is not null, 1, 0) hasReport, ec.studentId FROM erp_contract_orders o JOIN erp_contract c ON o.`contractFid` = c.`contractId` LEFT JOIN erp_clients ec ON ec.`clientId` = o.`clientId` LEFT JOIN mis_user_info u ON u.`userId` = ec.`chargeFid` LEFT JOIN mis_user_info tu2 ON tu2.userId = ec.consultantId LEFT JOIN erp_order_status s ON s.`statusId` = o.`orderStatus` left join ( SELECT DATE_FORMAT(max(l.startTime), '%Y-%m-%d %H:%i') startTime,IFNULL(sum(courseHours),0) courseHours, l.contractId FROM erp_lessons l WHERE l.lessonStatus in (1,3,4) AND l.contractId>0 GROUP BY l.contractId ) maxel on maxel.contractId=o.contractId LEFT JOIN ( SELECT DISTINCT r.orderFid FROM erp_learn_report r )elr on elr.orderFid=o.contractId WHERE o.orderStatus>0  and 2=2 and ec.chargeFid in ( 900001430 ) and not exists (select 1 from user_test ut where ut.userId = ec.studentId and ut.accType = 'STU') ORDER BY o.contractId DESC LIMIT 0, 10",工单列表查询,需要根据业务相应调整
1,3962,3s,10s,4s,5s,erpuser,"SELECT b.*,mui.userRealName operatorName, t1.importCnt FROM erp_lesson_book_files b LEFT JOIN mis_user_info mui on mui.userId = b.operator LEFT JOIN ( SELECT t.fileId,COUNT(DISTINCT t.lessonId) importCnt FROM erp_lesson_docs t WHERE t.parentId = 0 AND t.fileId != 0 GROUP BY t.fileId ) t1 ON t1.fileId=b.fileId WHERE catalogCode like '%tdwaoj/%' and parentId = 0 order by fileStatus desc, createTime desc limit 0,20",erp:查询课件,
2,3854,3s,115s,4s,5s,erpuser,"SELECT count(*) FROM erp_lesson_book_files b LEFT JOIN mis_user_info mui ON mui.userId = b.operator LEFT JOIN (SELECT t.fileId, COUNT(DISTINCT t.lessonId) importCnt FROM erp_lesson_docs t WHERE t.parentId = 0 AND t.fileId != 0 GROUP BY t.fileId) t1 ON t1.fileId = b.fileId WHERE catalogCode LIKE '%lrwhgc/siaijv/%' AND parentId = 0",erp:查询课件总数,
70,10,2s,7s,3s,3s,misuser,"SELECT count(1) FROM erp_contract_orders o JOIN erp_contract c ON o.`contractFid` = c.`contractId` LEFT JOIN erp_clients ec ON ec.`clientId` = o.`clientId` LEFT JOIN mis_user_info u ON u.`userId` = ec.`chargeFid` LEFT JOIN mis_user_info tu2 ON tu2.userId = ec.consultantId left join ( SELECT DATE_FORMAT(max(l.startTime), '%Y-%m-%d %H:%i') startTime,IFNULL(sum(courseHours),0) courseHours, l.contractId FROM erp_lessons l WHERE l.lessonStatus in (1,3,4) AND l.contractId>0 GROUP BY l.contractId ) maxel on maxel.contractId=o.contractId LEFT JOIN ( SELECT DISTINCT r.orderFid FROM erp_learn_report r )elr on elr.orderFid=o.contractId WHERE o.orderStatus>0  and 2=2 and ec.chargeFid in ( 900001430 ) and not exists (select 1 from user_test ut where ut.userId = ec.studentId and ut.accType = 'STU')",api:订单列表数,
16,151,2s,5s,3s,4s,erpuser,"SELECT l.*, IFNULL(c.clientName,t.nickName) studentName, mui.userRealName teacherName, g.gradeName gradeName, s.subjectName subjectName, o1.userRealName ccName, u1.userRealName chargeName, u1.userMobile chargePhone, stulc.param1 stuParam1, stulc.param2 stuParam2, stulc.param3 stuParam3, stulc.param4 stuParam4, tealc.param1 teaParam1, tealc.param2 teaParam2, tealc.param3 teaParam3, c.eduSystem FROM erp_lessons l LEFT JOIN erp_clients c ON l.clientId=c.clientId LEFT JOIN t_user_info t ON l.studentId=t.id LEFT JOIN mis_user_info mui ON mui.userId = l.teacherId LEFT JOIN erp_conf_student_grades g ON l.gradeId=g.gradeId LEFT JOIN erp_conf_course_subjects s ON l.subjectId=s.subjectId LEFT JOIN mis_user_info o1 ON o1.userId = c.consultantId LEFT JOIN mis_user_info u1 ON u1.userId=c.chargeFid LEFT JOIN lesson_comment stulc ON stulc.lessonFid=l.lessonId and stulc.commentBy='STU' LEFT JOIN lesson_comment tealc ON tealc.lessonFid=l.lessonId and tealc.commentBy='TEA' WHERE (c.clientName like '%鲍美霖%' OR t.nickName like '%鲍美霖%') and (c.consultantId in ( 107157 , 110244 , 115245 , 115877 , 117466 , 118233 , 121446 , 900000059 , 900000151 , 900000326 , 900000378 , 900000380 , 900000414 , 900000458 , 900000460 , 900000475 , 900000482 , 900000561 , 900000581 , 900000582 /*... omitted 70 items ...*/) or EXISTS (select distinct 1 from erp_client_cr t1 where t1.clientFid=l.clientId and t1.endTime is null and t1.crFid in ( 107157 , 110244 , 115245 , 115877 , 117466 , 118233 , 121446 , 900000059 , 900000151 , 900000326 , 900000378 , 900000380 , 900000414 , 900000458 , 900000460 , 900000475 , 900000482 , 900000561 , 900000581 , 900000582 /*... omitted 70 items ...*/))) order by startTime desc limit 0,20",erp:课程明细列表,
37,33,3s,5s,4s,5s,misuser,"SELECT temp.lessonDate,temp.scheduleId,GROUP_CONCAT(teacherIds) teacherIds FROM ( SELECT lessonDate,scheduleId,CONCAT(',',(GROUP_CONCAT(DISTINCT teacherId)),',') teacherIds FROM erp_teacher_schedule WHERE lessonId > 0 AND lessonDate BETWEEN '2018-04-15' and DATE_ADD('2018-04-15',INTERVAL 6 DAY) GROUP BY lessonDate,scheduleId UNION SELECT lessonDate,scheduleId,(SELECT CONCAT(',',GROUP_CONCAT(mti1.userFid),',') FROM mis_teacher_info mti1 WHERE mti1.teacherType=1 and mti1.isTeach = 1 AND NOT FIND_IN_SET(mti1.userFid,IFNULL(teacherIds,''))) teacherIds from( select b.scheduleId,b.date lessonDate,temp.teacherIds from ( select a.scheduleId,t.date from erp_conf_lesson_schedule_201609 a,( select w.date from mis_calendar_week w where w.date between (select subdate('2018-04-15',if(date_format('2018-04-15','%w')=0,7,date_format('2018-04-15','%w'))-1)) and date_add((select subdate('2018-04-15',if(date_format('2018-04-15','%w')=0,7,date_format('2018-04-15','%w'))-1)),INTERVAL 6 DAY) ) t ) b left join ( select et.scheduleId scheduleId,date_format(date_add((select subdate('2018-04-15',if(date_format('2018-04-15','%w')=0,7,date_format('2018-04-15','%w'))-1)),INTERVAL (IF(et.dayOfWeek=1,6,et.dayOfWeek-2)) DAY),'%Y-%m-%d') lessonDate , CONCAT(',',GROUP_CONCAT(mti.userFid),',') teacherIds from mis_teacher_info mti,erp_timetable et where ( exists(select 1 from erp_conf_timetable tmpect where tmpect.relatedFid=mti.timetableFid and et.timetableFid=tmpect.timetableId and (select subdate('2018-04-15',if(date_format('2018-04-15','%w')=0,7,date_format('2018-04-15','%w'))-1)) between tmpect.beginDate and tmpect.endDate) or ( not exists(select 1 from erp_conf_timetable tmpect where tmpect.relatedFid=mti.timetableFid and (select subdate('2018-04-15',if(date_format('2018-04-15','%w')=0,7,date_format('2018-04-15','%w'))-1)) between tmpect.beginDate and tmpect.endDate) and et.timetableFid=mti.timetableFid ) ) AND mti.teacherType=1 and mti.isTeach = 1 GROUP BY lessonDate,scheduleId )temp on b.scheduleId = temp.scheduleId and b.date = temp.lessonDate ) t UNION SELECT lessonDate,scheduleId,(SELECT CONCAT(',',GROUP_CONCAT(mti1.userFid),',') FROM mis_teacher_info mti1 WHERE mti1.teacherType=1 and mti1.isTeach = 1 AND NOT FIND_IN_SET(mti1.userFid,IFNULL(teacherIds,''))) teacherIds from( select b.scheduleId,b.date lessonDate,temp.teacherIds from ( select a.scheduleId,t.date from erp_conf_lesson_schedule_201609 a,( select w.date from mis_calendar_week w where w.date between (select subdate('2018-04-16',if(date_format('2018-04-16','%w')=0,7,date_format('2018-04-16','%w'))-1)) and date_add((select subdate('2018-04-16',if(date_format('2018-04-16','%w')=0,7,date_format('2018-04-16','%w'))-1)),INTERVAL 6 DAY) ) t ) b left join ( select et.scheduleId scheduleId,date_format(date_add((select subdate('2018-04-16',if(date_format('2018-04-16','%w')=0,7,date_format('2018-04-16','%w'))-1)),INTERVAL (IF(et.dayOfWeek=1,6,et.dayOfWeek-2)) DAY),'%Y-%m-%d') lessonDate , CONCAT(',',GROUP_CONCAT(mti.userFid),',') teacherIds from mis_teacher_info mti,erp_timetable et where ( exists(select 1 from erp_conf_timetable tmpect where tmpect.relatedFid=mti.timetableFid and et.timetableFid=tmpect.timetableId and (select subdate('2018-04-16',if(date_format('2018-04-16','%w')=0,7,date_format('2018-04-16','%w'))-1)) between tmpect.beginDate and tmpect.endDate) or ( not exists(select 1 from erp_conf_timetable tmpect where tmpect.relatedFid=mti.timetableFid and (select subdate('2018-04-16',if(date_format('2018-04-16','%w')=0,7,date_format('2018-04-16','%w'))-1)) between tmpect.beginDate and tmpect.endDate) and et.timetableFid=mti.timetableFid ) ) AND mti.teacherType=1 and mti.isTeach = 1 GROUP BY lessonDate,scheduleId )temp on b.scheduleId = temp.scheduleId and b.date = temp.lessonDate ) t ) temp where lessonDate BETWEEN '2018-04-15' and DATE_ADD('2018-04-15',INTERVAL 6 DAY) GROUP BY lessonDate,scheduleId","cloud试听库存列表,已排课老师（不包含请假）",
63,16,2s,3s,2s,3s,misuser,delete from erp_teacher_schedule WHERE isFree = 1 AND lessonId IN (SELECT l.lessonId FROM erp_lessons l WHERE l.contractId = 15386 AND l.lessonStatus = 0 ),api 换老师、停课，删除老师课表数据,
7,150,8s,27s,13s,18s,misuser,"insert IGNORE client_sea(clientFid, clientSea, flag, clientType, viewTime, latestFollowTime) SELECT ec.clientId,ec.clientSea,ec.flag,ec.clientType ,ec.viewTime,ifnull(ecf.createdOn,now()) from erp_clients ec left join( select max(id) id,clientFid,count(0) followNum,max(createdOn) createdOn from erp_client_follow where followStatusFid in(select statusId from erp_follow_status where type like '%,CC,%') GROUP BY clientFid ) ecf on ecf.clientFid=ec.clientId WHERE ec.clientSea='P' and ec.clientType = 'C' and ec.viewTime<=now() and ec.flag is not null and not exists(select 1 from callcenter_outer_log where ec.clientId=callcenter_outer_log.clientFid and createdOn>date_add(now(),INTERVAL -120 MINUTE)) and ec.phoneNo REGEXP '^[0]?[1][3456789][0-9]{9}$' and not exists(select 1 from callcenter_outer_log where ec.clientId=callcenter_outer_log.clientFid and createdOn>date_add(now(),INTERVAL -120 MINUTE)) and date(ec.createdOnTime) >='2016-01-01' and date(ec.createdOnTime) <='2018-03-20'  and ec.secondChannelFid not in(21006,27001,27006,21002,21001,39003,27008,27005,27004,21005,39001,39004,39002,21004,39010,39009,21003,39012,39005,39006/*... omitted 10 items ...*/) ORDER BY ec.topTimes>0 desc,ec.viewTime asc LIMIT 1000",event 客户海数据查询插入,
12,103,6s,16s,8s,11s,misuser,"insert IGNORE client_sea(clientFid, clientSea, flag, clientType, viewTime, latestFollowTime) SELECT ec.clientId,ec.clientSea,ec.flag,ec.clientType ,ec.viewTime,ifnull(ecf.createdOn,now()) from erp_clients ec left join(select max(createdOn) createdOn,clientFid,count(0) followNum from erp_client_follow where followStatusFid in(select statusId from erp_follow_status where type like '%,CC,%') GROUP BY clientFid ) ecf on ecf.clientFid=ec.clientId where ec.clientSea='P' and ec.clientType in ('R','N') and ec.viewTime <= now() and ec.flag is not null and ec.phoneNo REGEXP '^[0]?[1][3456789][0-9]{9}$' and not exists(select 1 from callcenter_outer_log where ec.clientId=callcenter_outer_log.clientFid and createdOn>date_add(now(),INTERVAL -120 MINUTE)) ORDER BY ec.topTimes>0 desc,ec.viewTime asc LIMIT 1000",event 客户海数据查询插入,
35,75,2s,2s,2s,2s,misuser,"select count(0) from erp_contract_orders tmpeco join ( select eof.orderFid,eof.orderStatusFid from erp_order_flow eof join (select max(flowId) flowId from erp_order_flow where orderStatusFid>0 and createdOn < '2018-04-09 11:48:02' GROUP BY orderFid) tmp on tmp.flowId=eof.flowId ) tmpeof on tmpeco.contractId=tmpeof.orderFid LEFT JOIN (select contractId,sum(courseHours) overHours from erp_lessons where lessonStatus in(1,3,4) and contractId>0 GROUP BY contractId) tmpel on tmpel.contractId=tmpeco.contractId where tmpeof.orderStatusFid in(1,2,6) and (orderStatusFid=1 or tmpel.overHours!=tmpeco.realLessonCount) and tmpeco.teacherId=900000967 and tmpeco.subjectId=3 and tmpeco.contractId!=21711 and tmpeco.clientId=406249",event 教师kpi 结果map返回判断是否有未结课订单,
22,145,2s,2s,2s,2s,misuser,"select count(0) from erp_contract_orders tmpeco join ( select eof.orderFid,eof.orderStatusFid from erp_order_flow eof join (select max(flowId) flowId from erp_order_flow where orderStatusFid>0 and createdOn < '2018-04-14 11:14:55' GROUP BY orderFid) tmp on tmp.flowId=eof.flowId ) tmpeof on tmpeco.contractId=tmpeof.orderFid LEFT JOIN (select contractId,sum(courseHours) overHours from erp_lessons where lessonStatus in(1,3,4) and contractId>0 GROUP BY contractId) tmpel on tmpel.contractId=tmpeco.contractId where tmpeof.orderStatusFid in(1,2,6) and (orderStatusFid=1 or tmpel.overHours!=tmpeco.realLessonCount) and tmpeco.subjectId=2 and tmpeco.contractId!=7851 and tmpeco.clientId=207705",event 教师kpi 结果map返回判断是否有未结课订单,
27,124,2s,2s,2s,2s,misuser,"select count(0) from erp_contract_orders tmpeco join ( select eof.orderFid,eof.orderStatusFid from erp_order_flow eof join (select max(flowId) flowId from erp_order_flow where orderStatusFid>0 and createdOn < '2018-04-14 18:45:00' GROUP BY orderFid) tmp on tmp.flowId=eof.flowId ) tmpeof on tmpeco.contractId=tmpeof.orderFid LEFT JOIN (select contractId,sum(courseHours) overHours from erp_lessons where lessonStatus in(1,3,4) and contractId>0 GROUP BY contractId) tmpel on tmpel.contractId=tmpeco.contractId where tmpeof.orderStatusFid in(1,2,6) and (orderStatusFid=1 or tmpel.overHours!=tmpeco.realLessonCount) and tmpeco.contractId!=27711 and tmpeco.clientId=280834",event 教师kpi 结果map返回判断是否有未结课订单,
54,21,2s,4s,3s,3s,misuser,"select count(distinct clientFid) finishClientCount from erp_contract co inner join (select o.contractFid,max(startTime) startTime,sum(courseHours) courseHours from erp_contract_orders o ,(select contractId,max(startTime) startTime,sum(courseHours) courseHours from erp_lessons where lessonStatus in(1,3,4) group by contractId) l where o.contractId=l.contractId group by o.contractFid) oo on co.contractId=oo.contractFid and co.contractFlag='N' where date(startTime) between '2018-04-02' and '2018-04-29' and co.totalLessonCount=courseHours and studentFid not in(select userId from user_test where accType='STU') and co.clientFid not in(select clientId from erp_contract coo,erp_contract_orders o left join (select contractId,sum(courseHours) courseHours from erp_lessons where contractId>0 and lessonStatus in(1,3,4) and startTime < date_add('2018-04-29',interval 1 day) group by contractId) l on o.contractId=l.contractId where o.contractFid=coo.contractId and coo.payTime < '2018-04-02' and ifnull(l.courseHours,0)!=realLessonCount)",CR KPI findCrFinishClientCount,
59,18,2s,5s,3s,3s,misuser,"select count(distinct clientId) pauseStudentCount from erp_contract_orders o,( select ff.orderFid,orderStatusFid from erp_order_flow ff ,(select orderFid, max(createdOn) createdOn from erp_order_flow where createdOn < date_add('2018-04-15',interval 1 day) and orderStatusFid>0 group by orderFid) fff where ff.createdOn=fff.createdOn and ff.orderFid=fff.orderFid) f where o.contractId=f.orderFid and f.orderStatusFid in(6) and studentId not in(select userId from user_test) and clientId not in(select clientId from erp_contract_orders o,( select ff.orderFid,orderStatusFid from erp_order_flow ff ,(select orderFid, max(createdOn) createdOn from erp_order_flow where createdOn < date_add('2018-04-15',interval 1 day) and orderStatusFid>0 group by orderFid) fff where ff.createdOn=fff.createdOn and ff.orderFid=fff.orderFid) f where o.contractId=f.orderFid and f.orderStatusFid in(1,2))",TOTAL KPI findTotalPauseStudentCount,
29,36,5s,7s,6s,7s,misuser,"select distinct ec.clientId, ec.clientName, ec.phoneNo, ec.studentId, ec.consultantId, ec.chargeFid, u1.userRealName ccName, u2.userRealName crName from erp_clients ec left join mis_user_info u1 on ec.consultantId = u1.userId left join mis_user_info u2 on ec.chargeFid = u2.userId left join erp_client_family f on ec.clientId = f.clientFid left join t_user_info t on ec.studentId = t.id and (t.accountType = 0 or t.accountType = 1) WHERE (ec.phoneNo = '18825139199' or ec.clientName = '18825139199' or familyPhoneNo = '18825139199' or t.mobileNo = '18825139199')",邀请管理-根据手机号查客户信息 getClientByMobileNo,
39,35,2s,3s,3s,3s,misuser,"select eco.clientId clientFid,date('2018-04-16') beginDate,date('2018-04-22') endDate,'W' period,'STU_PAUSE' sItem, eco.studentId studentFid,ec.clientName studentName, eco.subjectId subjectFid,eco.subjectName, max(el.startTime) lastLessonTime from erp_contract_orders eco join erp_clients ec on ec.clientId=eco.clientId join mis_teacher_info mti on mti.userFid=eco.teacherId left join ( select eof.orderFid,eof.orderStatusFid from erp_order_flow eof join (select max(flowId) flowId from erp_order_flow where orderStatusFid>0 and date(createdOn) <= '2018-04-22' GROUP BY orderFid) tmp on tmp.flowId=eof.flowId ) eof on eco.contractId=eof.orderFid left join (select contractId,max(startTime) startTime,sum(courseHours) overHours from erp_lessons where lessonStatus=1 and contractId>0 and startTime <= '2018-04-22' GROUP BY contractId) el on el.contractId=eco.contractId where eco.studentId not in(select userId from user_test where accType='STU') and mti.isMaturity=1 and mti.userFid in(103120,103150,103434,103948,104334,104915,105164,105260,105616,105653,105743,105757,105857,105874,106087,107654,107683,107963,108447,108453/*... omitted 548 items ...*/) and eco.subjectId=3 and (eof.orderStatusFid=6 or (el.startTime is not null and el.overHours!=eco.realLessonCount and date_add(el.startTime,INTERVAL 28 DAY) <= '2018-04-22')) GROUP BY eco.clientId",event教师kpi StatisticsTeachWService.java stuPauseListByGD,
45,30,2s,7s,3s,3s,misuser,"select ifnull(sum(if(ec.flag in('A1','A2'),1,0)),0) AClientNum, ifnull(sum(if(ec.flag='B',1,0)),0) BClientNum, count(0) totalNum, date_format(now(),'%H:%i') now, ifnull( sum(if(ec.flag in('A1','A2') and ecf.clientFid is null,1,0)),0) AClientNoFollowNum, ifnull(sum(if(ec.flag = 'B' and ecf.clientFid is null,1,0)),0) BClientNoFollowNum, ifnull(sum(if(ecf.clientFid is null,1,0)),0) clientNoFollowNum from erp_clients ec left join ( SELECT clientFid FROM erp_client_follow ecf where ecf.clientFid not in(select statusId from erp_follow_status where type=',SYS,') GROUP BY clientFid ) ecf on ecf.clientFid=ec.clientId where ec.clientSea='T'",event 领海客户数量短信提醒，findClientSeaTip,
48,30,2s,5s,3s,4s,misuser,"select l.lessonId,if(contractId>0,'订单课','试听课') lessonType,concat(DATE_FORMAT(l.startTime, '%Y-%m-%d %k:%i'),'-',DATE_FORMAT(l.endTime, '%k:%i')) lessonTime ,tu.userRealName teacherName,c.clientName studentName, l.lessonStatus from erp_lessons l join mis_user_info tu on tu.userId=l.teacherId join erp_clients c on c.clientId=l.clientId where tu.userId=l.teacherId and c.clientId=l.clientId and date(l.startTime) <= date(now()) and (l.lessonId='928049' or c.clientName='928049' or tu.userRealName='928049') order by l.startTime desc limit 10",api 获取课程设备信息ServerService.java findLessonDeviceInfo,
19,137,2s,4s,3s,3s,misuser,"select w.configId configFid,w.configType,w.configChildType,w.configPriority, w.configDeadline,w.configName,w.configContent configContent,w.configObject,w.configRemind, 0 sendByFid,'系统' sendBy,1 status, c.clientId clientFid,c.clientName,c.studentId studentFid, t.realName studentName,co.contractId contractFid,co.contractNo,o.contractId orderFid,l.lessonId lessonFid, l.subjectId subjectFid,s.subjectName,l.teacherId teacherFid, i.userRealName teacherName,l.gradeId gradeFid,g.gradeName,round(timestampdiff(DAY,t.startTime,now())/14,0) workFlag FROM erp_lessons l JOIN ( select clientId,min(startTime) startTime from erp_lessons WHERE lessonStatus = 1 and lessonType = 10 GROUP BY clientId HAVING min(startTime) > DATE_SUB(now(),INTERVAL 30 DAY) ) t on l.startTime = t.startTime and l.clientId = t.clientId JOIN erp_contract_orders o on o.contractId = l.contractId JOIN erp_contract co on co.contractId = o.contractFid JOIN erp_clients c on l.clientId = c.clientId left join t_user_info t on c.studentId = t.id left join mis_user_info i on l.teacherId = i.userId left join erp_conf_student_grades g on l.gradeId = g.gradeId left join erp_conf_course_subjects s on l.subjectId = s.subjectId ,mis_work_order_config w where w.configId = 23 and timestampdiff(DAY,t.startTime,now())%14 = 0 and timestampdiff(DAY,t.startTime,now()) > 0 and co.contractProp = 1 and not exists(select 1 from mis_work_order o where o.configFid = w.configId and l.lessonId = o.lessonFid and workFlag = round(timestampdiff(DAY,t.startTime,now())/14,0))",工单生成14天未上课,基本都与首次课有关，可以在客户event那张表添加首次课ID、首次课时间
25,106,2s,4s,3s,3s,misuser,"select w.configId configFid,w.configType,w.configChildType,w.configPriority, w.configDeadline,w.configName,w.configContent configContent,w.configObject,w.configRemind, 0 sendByFid,'系统' sendBy,1 status, c.clientId clientFid,c.clientName,c.studentId studentFid,t.realName studentName,co.contractId contractFid,co.contractNo contractNo,o.contractId orderFid,0 lessonFid, o.subjectId subjectFid,s.subjectName,o.teacherId teacherFid,i.userRealName teacherName,o.gradeId gradeFid,g.gradeName,round(temp.completeCount/5,0) workFlag from erp_contract_orders o join erp_contract co on co.contractId = o.contractFid join erp_clients c on o.clientId = c.clientId join t_user_info t on o.studentId = t.id join mis_user_info i on o.teacherId = i.userId join erp_conf_student_grades g on o.gradeId = g.gradeId join erp_conf_course_subjects s on o.subjectId = s.subjectId join ( SELECT o.contractFid,o.teacherId,o.subjectId,o.clientId,sum(tmp.lessonCount) lessonCount,sum(tmp.lessonNum) completeCount from erp_contract_orders o JOIN erp_contract ec on o.contractFid = ec.contractId JOIN ( SELECT contractId,sum(courseHours) lessonCount,count(contractId) lessonNum FROM erp_lessons WHERE lessonStatus = 1 AND contractId>0 GROUP BY contractId ) tmp on o.contractId = tmp.contractId GROUP BY o.teacherId,o.subjectId,o.clientId HAVING sum(tmp.lessonNum)%5 = 0 AND sum(tmp.lessonNum)>0 )temp on o.clientId = temp.clientId and o.teacherId = temp.teacherId and o.subjectId = temp.subjectId JOIN ( select tm.clientId,tm.teacherId,tm.subjectId,sum(renainLessonCount) renainLessonCount from ( select o.contractId,o.clientId,o.teacherId,o.subjectId,(o.realLessonCount - ifnull(sum(l.courseHours),0)) renainLessonCount from erp_contract_orders o left JOIN erp_lessons l on o.contractId = l.contractId where l.lessonStatus in (1,3,4) GROUP BY o.contractId ) tm GROUP BY tm.clientId,tm.teacherId,tm.subjectId ) tmp on o.subjectId = tmp.subjectId and o.teacherId = tmp.teacherId and o.clientId = tmp.clientId left join ( select teacherId,subjectId,clientId,sum(planCount) planCount from ( select o.teacherId,o.subjectId,o.clientId,round(count(p.planId)/5,0) planCount from erp_lesson_plan p JOIN erp_contract_orders o on p.contractId = o.contractId where o.teacherId>0 GROUP BY o.teacherId,o.subjectId,o.clientId UNION ALL SELECT teacherFid teacherId,subjectFid subjectId,clientFid clientId,count(id) planCount FROM teach_lesson_plan GROUP BY teacherFid,subjectFid,clientFid ) tmp GROUP BY teacherId,subjectId,clientId ) tm on o.subjectId = tm.subjectId and o.teacherId = tm.teacherId and o.clientId = tm.clientId ,mis_work_order_config w where w.configId = 9 and not exists(select 1 from mis_work_order o1 where o1.configFid = w.configId AND o1.clientFid = o.clientId AND o1.subjectFid = o.subjectId AND o1.teacherFid = o.teacherId and workFlag = round(temp.completeCount/5,0)) and o.contractFid != o.contractId and o.contractId>0 and tmp.renainLessonCount >0 and round(temp.completeCount/5,0) > (ifnull(planCount,0)-1) GROUP BY o.clientId,o.subjectId,o.teacherId",工单生成5次课程规划,
24,112,2s,19s,3s,3s,misuser,"select w.configId configFid,w.configType,w.configChildType,w.configPriority, w.configDeadline,w.configName,w.configContent configContent,w.configObject,w.configRemind, 0 sendByFid,'系统' sendBy,1 status, c.clientId clientFid,c.clientName,c.studentId studentFid,t.realName studentName,co.contractId contractFid,co.contractNo contractNo,o.contractId orderFid,temp.lessonId lessonFid, o.subjectId subjectFid,s.subjectName,o.teacherId teacherFid,i.userRealName teacherName,o.gradeId gradeFid,g.gradeName from erp_contract_orders o join erp_contract co on co.contractId = o.contractFid join erp_clients c on o.clientId = c.clientId join t_user_info t on o.studentId = t.id join mis_user_info i on o.teacherId = i.userId join erp_conf_student_grades g on o.gradeId = g.gradeId join erp_conf_course_subjects s on o.subjectId = s.subjectId join ( select contractId,l.lessonId from erp_lessons l, ( select clientId,subjectId,teacherid,max(startTime) startTime from erp_lessons where lessonStatus=1 AND startTime > date_sub(now(),INTERVAL 30 DAY) and lessonType=10 GROUP BY subjectId,clientId,teacherId HAVING timestampdiff(day,max(startTime),now())= 28 ) ll where l.clientId=ll.clientId and l.subjectId=ll.subjectId and l.teacherId=ll.teacherId and l.startTime=ll.startTime ) temp on o.contractId = temp.contractId ,mis_work_order_config w where w.configId = 20 and o.orderStatus = 2 and not exists(select 1 from mis_work_order wo where wo.configFid = w.configId and wo.lessonFid = temp.lessonId) and not exists(select 1 from erp_student_teach_special s where c.clientId = s.clientFid)",工单生成连续28天未上课预警,
14,252,2s,27s,3s,4s,misuser,"select w.configId configFid,w.configType,w.configChildType,w.configPriority, w.configDeadline,w.configName,w.configContent configContent,w.configObject,w.configRemind, 0 sendByFid,'系统' sendBy,1 status, c.clientId clientFid,c.clientName,c.studentId studentFid,t.realName studentName,co.contractId contractFid,co.contractNo,o.contractId orderFid,l.lessonId lessonFid, l.subjectId subjectFid,s.subjectName,l.teacherId teacherFid,i.userRealName teacherName,l.gradeId gradeFid,g.gradeName FROM erp_lessons l JOIN ( select clientId,min(startTime) startTime from erp_lessons WHERE lessonStatus = 1 and lessonType = 10 GROUP BY clientId HAVING min(startTime) > DATE(now()) ) t on l.clientId = t.clientId and l.startTime = t.startTime JOIN erp_contract_orders o on o.contractId = l.contractId JOIN erp_contract co on co.contractId = o.contractFid join erp_clients c on l.clientId = c.clientId left join t_user_info t on c.studentId = t.id left join mis_user_info i on l.teacherId = i.userId left join erp_conf_student_grades g on l.gradeId = g.gradeId left join erp_conf_course_subjects s on l.subjectId = s.subjectId ,mis_work_order_config w where w.configId = 10 and co.contractProp = 1 and not exists(select 1 from mis_work_order o where o.configFid = w.configId and l.lessonId = o.lessonFid)",工单生成首次课课后回访,
32,70,2s,4s,2s,3s,misuser,"select w.configId configFid,w.configType,w.configChildType,w.configPriority, w.configDeadline,w.configName,w.configContent configContent,w.configObject,w.configRemind, 0 sendByFid,'系统' sendBy,1 status, c.clientId clientFid,c.clientName,c.studentId studentFid,t.realName studentName,co.contractId contractFid,co.contractNo,o.contractId orderFid,l.lessonId lessonFid, l.subjectId subjectFid,s.subjectName,l.teacherId teacherFid,i.userRealName teacherName,l.gradeId gradeFid,g.gradeName FROM erp_lessons l join ( select clientId,min(lessonId) lessonId from erp_lessons WHERE lessonType = 10 GROUP BY clientId ) t on l.lessonId = t.lessonId JOIN erp_contract_orders o on o.contractId = l.contractId JOIN erp_contract co on co.contractId = o.contractFid join erp_clients c on l.clientId = c.clientId left join t_user_info t on c.studentId = t.id left join mis_user_info i on l.teacherId = i.userId left join erp_conf_student_grades g on l.gradeId = g.gradeId left join erp_conf_course_subjects s on l.subjectId = s.subjectId ,mis_work_order_config w where w.configId = 7 and l.createTime > DATE(now()) and co.contractProp = 1 and not exists(select 1 from mis_work_order o where o.configFid = w.configId and l.lessonId = o.lessonFid)",工单生成首次课课前回访,
20,117,2s,4s,3s,3s,misuser,"select w.configId configFid,w.configType,w.configChildType,w.configPriority, w.configDeadline,w.configName,w.configContent configContent,w.configObject,w.configRemind, 0 sendByFid,'系统' sendBy,1 status, c.clientId clientFid,c.clientName,c.studentId studentFid,t.realName studentName,co.contractId contractFid,co.contractNo,o.contractId orderFid,l.lessonId lessonFid, l.subjectId subjectFid,s.subjectName,l.teacherId teacherFid,i.userRealName teacherName,l.gradeId gradeFid,g.gradeName,1 workFlag FROM erp_lessons l JOIN ( select clientId,min(startTime) startTime from erp_lessons WHERE lessonStatus = 1 and lessonType = 10 GROUP BY clientId HAVING min(startTime) = DATE_SUB(now(),INTERVAL 30 DAY) ) t on l.startTime = t.startTime and l.clientId = t.clientId JOIN erp_contract_orders o on o.contractId = l.contractId JOIN erp_contract co on co.contractId = o.contractFid join erp_clients c on l.clientId = c.clientId left join t_user_info t on c.studentId = t.id left join mis_user_info i on l.teacherId = i.userId left join erp_conf_student_grades g on l.gradeId = g.gradeId left join erp_conf_course_subjects s on l.subjectId = s.subjectId ,mis_work_order_config w where w.configId = 12 and co.gradeFid not in (160,230,330) and co.contractProp = 1 and exists(select 1 from erp_contract ec where ec.clientFid = c.clientId and ec.contractStatus=3) and not exists(select 1 from mis_work_order o where o.configFid = w.configId and l.lessonId = o.lessonFid and workFlag = 1)",工单生成非毕业班学员常规服务,
23,106,2s,5s,3s,4s,misuser,"select w.configId configFid,w.configType,w.configChildType,w.configPriority, w.configDeadline,w.configName,w.configContent configContent,w.configObject,w.configRemind, 0 sendByFid,'系统' sendBy,1 status, c.clientId clientFid,c.clientName,c.studentId studentFid,t.realName studentName,co.contractId contractFid,co.contractNo,o.contractId orderFid,l.lessonId lessonFid, l.subjectId subjectFid,s.subjectName,l.teacherId teacherFid,i.userRealName teacherName,l.gradeId gradeFid,g.gradeName,1 workFlag FROM erp_lessons l JOIN ( select clientId,min(startTime) startTime from erp_lessons WHERE lessonStatus = 1 and lessonType = 10 GROUP BY clientId HAVING min(startTime) = DATE_SUB(now(),INTERVAL 30 DAY) ) t on l.startTime = t.startTime and l.clientId = t.clientId JOIN erp_contract_orders o on o.contractId = l.contractId JOIN erp_contract co on co.contractId = o.contractFid join erp_clients c on l.clientId = c.clientId left join t_user_info t on c.studentId = t.id left join mis_user_info i on l.teacherId = i.userId left join erp_conf_student_grades g on l.gradeId = g.gradeId left join erp_conf_course_subjects s on l.subjectId = s.subjectId ,mis_work_order_config w where w.configId = 14 and co.gradeFid in (160,230,330) and co.contractProp = 1 and exists(select 1 from erp_contract ec where ec.clientFid = c.clientId and ec.contractStatus=3) and not exists(select 1 from mis_work_order o where o.configFid = w.configId and l.lessonId = o.lessonFid and workFlag = 1)",工单生成毕业班学员常规服务,
28,85,2s,8s,3s,3s,misuser,"select w.configId configFid,w.configType,w.configChildType,w.configPriority, w.configDeadline,w.configName,w.configContent configContent,w.configObject,w.configRemind, 0 sendByFid,'系统' sendBy,1 status, c.clientId clientFid,c.clientName,c.studentId studentFid,t.realName studentName,co.contractId contractFid,co.contractNo,o.contractId orderFid,l.lessonId lessonFid, l.subjectId subjectFid,s.subjectName,l.teacherId teacherFid,i.userRealName teacherName,l.gradeId gradeFid,g.gradeName,round((datediff(now(),l.startTime)-30)/14,0)+1 workFlag FROM erp_lessons l JOIN ( select clientId,min(startTime) startTime from erp_lessons WHERE lessonStatus = 1 and lessonType = 10 GROUP BY clientId HAVING min(startTime) < DATE_SUB(now(),INTERVAL 30 DAY) ) t on l.startTime = t.startTime and l.clientId = t.clientId JOIN erp_contract_orders o on o.contractId = l.contractId JOIN erp_contract co on co.contractId = o.contractFid join erp_clients c on l.clientId = c.clientId left join t_user_info t on c.studentId = t.id left join mis_user_info i on l.teacherId = i.userId left join erp_conf_student_grades g on l.gradeId = g.gradeId left join erp_conf_course_subjects s on l.subjectId = s.subjectId ,mis_work_order_config w where w.configId = 13 and co.gradeFid not in (160,230,330) and co.contractProp = 1 and exists(select 1 from erp_contract ec where ec.clientFid = c.clientId and ec.contractStatus=3) and (datediff(now(),l.startTime)-30)%14=0 and not exists(select 1 from mis_work_order o where o.configFid = w.configId and l.lessonId = o.lessonFid and workFlag = round((datediff(now(),l.startTime)-30)/14,0)+1)",工单生成非毕业班学员常规服务,
26,98,2s,8s,3s,4s,misuser,"select w.configId configFid,w.configType,w.configChildType,w.configPriority, w.configDeadline,w.configName,w.configContent configContent,w.configObject,w.configRemind, 0 sendByFid,'系统' sendBy,1 status, c.clientId clientFid,c.clientName,c.studentId studentFid,t.realName studentName,co.contractId contractFid,co.contractNo,o.contractId orderFid,l.lessonId lessonFid, l.subjectId subjectFid,s.subjectName,l.teacherId teacherFid,i.userRealName teacherName,l.gradeId gradeFid,g.gradeName,round((datediff(now(),l.startTime)-30)/7,0)+1 workFlag FROM erp_lessons l JOIN ( select clientId,min(startTime) startTime from erp_lessons WHERE lessonStatus = 1 and lessonType = 10 GROUP BY clientId HAVING min(startTime) < DATE_SUB(now(),INTERVAL 30 DAY) ) t on l.startTime = t.startTime and l.clientId = t.clientId JOIN erp_contract_orders o on o.contractId = l.contractId JOIN erp_contract co on co.contractId = o.contractFid join erp_clients c on l.clientId = c.clientId left join t_user_info t on c.studentId = t.id left join mis_user_info i on l.teacherId = i.userId left join erp_conf_student_grades g on l.gradeId = g.gradeId left join erp_conf_course_subjects s on l.subjectId = s.subjectId ,mis_work_order_config w where w.configId = 15 and co.gradeFid in (160,230,330) and co.contractProp = 1 and exists(select 1 from erp_contract ec where ec.clientFid = c.clientId and ec.contractStatus=3) and (datediff(now(),l.startTime)-30)%7=0 and not exists(select 1 from mis_work_order o where o.configFid = w.configId and l.lessonId = o.lessonFid and workFlag = round((datediff(now(),l.startTime)-30)/7,0)+1)",工单生成毕业班学员常规服务,
82,10,2s,3s,2s,2s,misuser,update client_data_pool set flag='A1' where type='N' and exists(select 1 from erp_channel where erp_channel.id=client_data_pool.secondChannel and erp_channel.flag='A'),event 更新A渠道的flag  updateDataPoolFlagByAChannel,
